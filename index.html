<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>0ESG - Tracking DEI/ESG/Woke Related Losses</title>
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Basic Reset & Variables */
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #dddddd;
            --header-bg: #f8f8f8;
            --link-color: #007bff;
            --button-bg: #e7e7e7;
            --button-text: #333333;
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --chart-label-color: #666;
            --tooltip-bg: rgba(0, 0, 0, 0.8);
            --tooltip-text: #fff;
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --border-color: #444444;
            --header-bg: #2a2a2a;
            --link-color: #64b5f6;
            --button-bg: #333333;
            --button-text: #e0e0e0;
            --chart-grid-color: rgba(255, 255, 255, 0.1);
            --chart-label-color: #aaa;
            --tooltip-bg: rgba(255, 255, 255, 0.8);
            --tooltip-text: #000;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-color);
        }
         h1 {
            margin-bottom: 10px;
         }
        .intro {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1em;
            color: var(--text-color);
        }

        a {
            color: var(--link-color);
        }

        /* Dark Mode Toggle */
        #darkModeToggle {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            z-index: 1000; /* Ensure it's above charts */
        }
        #darkModeToggle:hover {
            opacity: 0.8;
        }


        /* Chart Containers */
        .chart-container {
            position: relative; /* Needed for chart responsiveness */
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color); /* Ensure charts have background in dark mode */
            height: 400px; /* Default height, adjust as needed */
            width: 100%; /* Take full width of container */
        }

        /* Responsive height adjustments */
        @media (min-width: 768px) {
            .chart-container {
                height: 450px;
            }
        }
        @media (min-width: 1024px) {
             .chart-container {
                height: 500px;
            }
             /* Adjust timeline height more specifically if needed */
            #timelineChartContainer {
                height: 600px; /* Allow more space for horizontal bars */
            }
        }


        /* Data Table */
        #dataTableContainer {
            margin-top: 40px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        #dataTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        #dataTable th, #dataTable td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }

        #dataTable thead th {
            background-color: var(--header-bg);
            position: sticky;
            top: 0; /* Stick header to top when scrolling */
            z-index: 10;
        }

        #dataTable tbody tr:nth-child(even) {
            background-color: var(--header-bg); /* Slight alternating background */
        }

        /* Loading/Error Message */
        #message {
            text-align: center;
            font-style: italic;
            margin-top: 20px;
            color: var(--text-color);
        }

        
        /* Form Styling */
        #formContainer {
             transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive grid */
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group.full-width {
             grid-column: 1 / -1; /* Span full width */
        }
         .form-group.submit-group {
            flex-direction: row;
            align-items: center;
            margin-top: 10px;
         }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1em;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
         .form-group small {
             font-size: 0.8em;
             color: #888;
             margin-top: 3px;
         }
         body.dark-mode .form-group small {
             color: #aaa;
         }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--link-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); /* Example focus */
        }
         body.dark-mode .form-group input:focus,
         body.dark-mode .form-group select:focus,
         body.dark-mode .form-group textarea:focus {
            box-shadow: 0 0 0 2px rgba(100, 181, 246, 0.25); /* Dark mode focus */
        }


        #submitBtn {
            padding: 10px 20px;
            background-color: var(--link-color);
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease, opacity 0.2s ease;
        }
        #submitBtn:hover {
            opacity: 0.9;
        }
        #submitBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
         body.dark-mode #submitBtn:disabled {
             background-color: #555;
         }

        #formMessage {
            font-style: italic;
        }
        #formMessage.success {
            color: #28a745;
        }
         body.dark-mode #formMessage.success {
             color: #77dd77;
         }
        #formMessage.error {
            color: #dc3545;
        }
        body.dark-mode #formMessage.error {
             color: #ff6961;
         }


        /* Thank You Overlay & Sparkles */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border-radius: 8px; /* Match container */
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
            z-index: 100; /* Above form elements */
        }
         body.dark-mode .overlay {
             background-color: rgba(255, 255, 255, 0.7);
         }

        .overlay.hidden {
            opacity: 0;
            pointer-events: none; /* Don't block interaction when hidden */
        }

        .overlay .sparkles {
            font-size: 2.5em; /* Make sparkles large */
            color: #ffd700; /* Gold color */
            animation: sparkle 1s ease-in-out infinite;
            margin-bottom: 15px;
        }
         .overlay p {
             font-size: 1.2em;
             color: #fff; /* White text on dark overlay */
             font-weight: bold;
         }
          body.dark-mode .overlay p {
              color: #333; /* Dark text on light overlay */
          }

        @keyframes sparkle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        
    </style>
</head>
<body>
    <button id="darkModeToggle">Toggle Dark Mode</button>

    <div class="container">
        <h1>0ESG.com (Demo)</h1>
        <p class="intro">
            Tracking estimated financial losses potentially related to DEI, ESG, and 'Woke' initiatives in the Entertainment and Video Game industries.
            <br>Data sourced from publicly available information and community estimates. View raw data <a href="#dataTableContainer">below</a>.
        </p>

        <div id="message"><p>Loading data...</p></div>

        <h2>Estimated Losses Per Year (Column Chart)</h2>
        <div class="chart-container" id="columnChartContainer">
            <canvas id="columnChart"></canvas>
        </div>

        <h2>Timeline of Estimated Losses (Bar Timeline)</h2>
        <p style="text-align: center; font-size: 0.9em; margin-bottom: 15px;">(Ordered by Year, showing Title vs. Estimated Loss)</p>
        <div class="chart-container" id="timelineChartContainer">
            <canvas id="timelineChart"></canvas>
        </div>

        <h2>Estimated Losses by Related Initiative Focus (Pie Chart)</h2>
        <div class="chart-container" id="pieChartContainer">
            <canvas id="pieChart"></canvas>
        </div>

        <!-- ... (Previous Charts) ... -->
        <h2>Submit New Data Entry</h2>
        <div id="formContainer" style="position: relative; border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; margin-bottom: 30px; background-color: var(--bg-color);">
            <form id="dataForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="title">Title:</label>
                        <input type="text" id="title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="industry">Industry:</label>
                        <select id="industry" name="industry" required>
                            <option value="">-- Select Industry --</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Video Games">Video Games</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="year">Year:</label>
                        <input type="number" id="year" name="year" min="1980" max="2099" step="1" required>
                    </div>
                     <div class="form-group">
                        <label for="type">Type:</label>
                         <select id="type" name="type" required>
                             <option value="">-- Select Type --</option>
                             <option value="Movie">Movie</option>
                             <option value="TV Show">TV Show</option>
                             <option value="Video Game">Video Game</option>
                             <option value="Company Initiative">Company Initiative</option>
                             <option value="Product Launch">Product Launch</option>
                             <option value="Other">Other</option>
                         </select>
                    </div>
                    <div class="form-group">
                        <label for="estimatedLoss">Estimated Loss (Millions $, e.g., 150):</label>
                        <input type="text" id="estimatedLoss" name="estimatedLoss" pattern="^\$?\d+(\.\d+)?M?$" placeholder="e.g., 150 or $150M" required>
                         <small>Enter number only, 'M' is optional.</small>
                    </div>
                    <div class="form-group">
                        <label for="relatedInitiativeFocus">Related Initiative Focus:</label>
                         <select id="relatedInitiativeFocus" name="relatedInitiativeFocus" required>
                             <option value="">-- Select Focus --</option>
                             <option value="DEI">DEI</option>
                             <option value="ESG">ESG</option>
                             <option value="Woke Messaging">Woke Messaging</option>
                             <option value="Combination">Combination</option>
                             <option value="Unspecified">Unspecified</option>
                             <option value="Other">Other</option>
                         </select>
                    </div>
                </div>
                 <div class="form-group full-width">
                    <label for="description">Description (Optional):</label>
                    <textarea id="description" name="description" rows="3"></textarea>
                </div>

                <div class="form-group full-width submit-group">
                    <button type="submit" id="submitBtn">Submit Data</button>
                    <span id="formMessage" style="margin-left: 15px;"></span>
                </div>
            </form>

             <!-- Thank You Message & Sparkles Container -->
             <div id="thankYouOverlay" class="overlay hidden">
                 <div class="sparkles">✨ Thank You! ✨</div>
                 <p>Data submitted successfully.</p>
             </div>
        </div>
        <!-- ... (Raw Data Table) ... -->
        
        <h2>Raw Data</h2>
        <div id="dataTableContainer">
            <table id="dataTable">
                <thead>
                    <tr id="tableHeader">
                        <!-- Header generated by JS -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Data rows generated by JS -->
                </tbody>
            </table>
        </div>
         <p style="text-align: center; font-size: 0.8em; margin-top: 30px; color: var(--text-color);">
            Disclaimer: Data is based on public reports and estimations, and causality is complex. This site presents correlations for informational purposes.
        </p>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTQw438ZKd6BpMMD7KRjyQI9xTjS467yFxecgkQOE3SOaTJx60w-TZnSxfbIuypkfLX1LjZcwf3xcU_/pub?gid=0&single=true&output=csv';
        
        // *** PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE ***
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbysKP1fwbXcL77dwprpIUJSrurU1CUfvQmbcJakhLkVawgpI_46fCy6dPGV4Lx0nupZ/exec'; // Replace with your actual URL
        
        // DOM Elements
        const messageEl = document.getElementById('message');
        const tableHeaderEl = document.getElementById('tableHeader');
        const tableBodyEl = document.getElementById('tableBody');
        const darkModeToggle = document.getElementById('darkModeToggle');
        // ... (Existing DOM Elements like messageEl, etc.) ...
        // Data form variables
        const dataForm = document.getElementById('dataForm');
        const submitBtn = document.getElementById('submitBtn');
        const formMessage = document.getElementById('formMessage');
        const thankYouOverlay = document.getElementById('thankYouOverlay');
        const industrySelect = document.getElementById('industry');
        const typeSelect = document.getElementById('type');
        const focusSelect = document.getElementById('relatedInitiativeFocus');

        // Chart instances (global to manage updates/destruction)
        let columnChartInstance = null;
        let timelineChartInstance = null;
        let pieChartInstance = null;
        let allData = []; // Store fetched data globally

        // --- Utility Functions ---

        // Basic CSV Parser (assumes simple structure, no commas within quoted fields)
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return []; // Need header + at least one data row

            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                // Skip empty lines potentially at the end of the CSV
                if (values.length !== headers.length || values.every(v => v === '')) {
                    continue;
                }
                const entry = {};
                headers.forEach((header, index) => {
                    entry[header] = values[index] || ''; // Handle potentially missing values
                });

                // Basic data cleaning/typing
                entry.id = entry.id ? parseInt(entry.id, 10) : null;
                entry.year = entry.year ? parseInt(entry.year, 10) : null;
                 // Clean currency format ($1,000M -> 1000) - Adapt based on actual sheet format
                if (entry.estimatedLoss) {
                     const lossString = entry.estimatedLoss.replace(/[\$,M]/g, ''); // Remove $, comma, M
                     entry.estimatedLoss = parseFloat(lossString) || 0; // Convert to number, default to 0 if invalid
                } else {
                     entry.estimatedLoss = 0;
                }

                // Ensure required fields have defaults if missing/invalid
                entry.title = entry.title || 'N/A';
                entry.industry = entry.industry || 'Unknown';
                entry.type = entry.type || 'Unknown';
                entry.relatedInitiativeFocus = entry.relatedInitiativeFocus || 'Unspecified';
                entry.description = entry.description || '';


                if (entry.id !== null && entry.year !== null) { // Only add valid entries
                    data.push(entry);
                }
            }
            return data;
        }

        // Get current chart colors based on mode
        function getChartColors() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            const bodyStyle = window.getComputedStyle(document.body);
            return {
                gridColor: bodyStyle.getPropertyValue('--chart-grid-color').trim(),
                labelColor: bodyStyle.getPropertyValue('--chart-label-color').trim(),
                tooltipBg: bodyStyle.getPropertyValue('--tooltip-bg').trim(),
                tooltipText: bodyStyle.getPropertyValue('--tooltip-text').trim(),
                // Define base colors for charts - can be customized further
                barColor: isDarkMode ? 'rgba(75, 192, 192, 0.8)' : 'rgba(54, 162, 235, 0.8)',
                pieColors: [ // Example palette, add more if needed
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)',
                    'rgba(199, 199, 199, 0.8)',
                     'rgba(83, 102, 255, 0.8)',
                ]
            };
        }

        // --- Data Processing and Chart Creation ---

        function processAndDisplayData(data) {
            allData = data; // Store data globally
            if (!data || data.length === 0) {
                messageEl.innerHTML = '<p>No valid data found or failed to parse.</p>';
                return;
            }

            messageEl.style.display = 'none'; // Hide loading message

            // 1. Populate Raw Data Table
            populateTable(data);

            // 2. Create Charts (call functions that will handle destruction/creation)
            createOrUpdateCharts();
        }

        function populateTable(data) {
            // Create Header Row
            tableHeaderEl.innerHTML = ''; // Clear existing header
            if (data.length > 0) {
                const headers = Object.keys(data[0]);
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    tableHeaderEl.appendChild(th);
                });
            }

            // Create Data Rows
            tableBodyEl.innerHTML = ''; // Clear existing rows
            data.forEach(item => {
                const tr = document.createElement('tr');
                Object.values(item).forEach(value => {
                    const td = document.createElement('td');
                    // Format numbers nicely if needed (e.g., currency)
                    if (typeof value === 'number' && !Number.isInteger(value)) {
                        td.textContent = value.toFixed(2); // Example: 2 decimal places for floats
                    } else if (typeof value === 'number' && item.estimatedLoss === value) {
                        // Crude check if it's the loss column, add 'M' back - adjust if format differs
                        td.textContent = `$${value}M`;
                    }
                     else {
                        td.textContent = value !== null ? value : ''; // Display empty string for null
                    }
                    tr.appendChild(td);
                });
                tableBodyEl.appendChild(tr);
            });
        }

        function createOrUpdateCharts() {
            if (!allData || allData.length === 0) return; // No data to chart

            const colors = getChartColors(); // Get colors for the current mode

            // Destroy existing charts before recreating
            if (columnChartInstance) columnChartInstance.destroy();
            if (timelineChartInstance) timelineChartInstance.destroy();
            if (pieChartInstance) pieChartInstance.destroy();

            // --- Chart 1: Column Chart (Losses per Year) ---
            const yearlyLosses = allData.reduce((acc, item) => {
                if (item.year && item.estimatedLoss > 0) {
                    acc[item.year] = (acc[item.year] || 0) + item.estimatedLoss;
                }
                return acc;
            }, {});

            const sortedYears = Object.keys(yearlyLosses).map(Number).sort((a, b) => a - b);
            const columnLabels = sortedYears.map(String);
            const columnData = sortedYears.map(year => yearlyLosses[year]);

            const columnCtx = document.getElementById('columnChart').getContext('2d');
            columnChartInstance = new Chart(columnCtx, {
                type: 'bar', // 'bar' is used for column charts in Chart.js
                data: {
                    labels: columnLabels,
                    datasets: [{
                        label: 'Total Estimated Loss (Millions $)',
                        data: columnData,
                        backgroundColor: colors.barColor,
                        borderColor: colors.barColor.replace('0.8', '1'), // Make border opaque
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Estimated Loss (Millions $)', color: colors.labelColor },
                            ticks: { color: colors.labelColor },
                            grid: { color: colors.gridColor }
                        },
                        x: {
                             title: { display: true, text: 'Year', color: colors.labelColor },
                             ticks: { color: colors.labelColor },
                             grid: { color: colors.gridColor }
                        }
                    },
                     plugins: {
                         title: { display: false }, // Already have H2
                         legend: { display: false },
                         tooltip: {
                            backgroundColor: colors.tooltipBg,
                            titleColor: colors.tooltipText,
                            bodyColor: colors.tooltipText,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                         // Add 'M' for millions
                                        label += '$' + context.parsed.y.toFixed(2) + 'M';
                                    }
                                    return label;
                                }
                            }
                         }
                     }
                }
            });

            // --- Chart 2: Bar Timeline (Loss vs Title, ordered by Year) ---
             const sortedDataForTimeline = [...allData].sort((a, b) => (a.year || 0) - (b.year || 0));
             const timelineLabels = sortedDataForTimeline.map(item => `${item.title} (${item.year})`);
             const timelineData = sortedDataForTimeline.map(item => item.estimatedLoss);

             const timelineCtx = document.getElementById('timelineChart').getContext('2d');
             timelineChartInstance = new Chart(timelineCtx, {
                 type: 'bar',
                 data: {
                     labels: timelineLabels,
                     datasets: [{
                         label: 'Estimated Loss (Millions $)',
                         data: timelineData,
                         backgroundColor: colors.barColor,
                         borderColor: colors.barColor.replace('0.8', '1'),
                         borderWidth: 1
                     }]
                 },
                 options: {
                     indexAxis: 'y', // Makes it a horizontal bar chart
                     responsive: true,
                     maintainAspectRatio: false,
                     scales: {
                         x: {
                             beginAtZero: true,
                             title: { display: true, text: 'Estimated Loss (Millions $)', color: colors.labelColor },
                             ticks: { color: colors.labelColor },
                             grid: { color: colors.gridColor }
                         },
                         y: {
                            ticks: { color: colors.labelColor, autoSkip: false, font: { size: 10 } }, // Show all labels, smaller font
                            grid: { display: false } // Hide vertical grid lines for clarity
                         }
                     },
                     plugins: {
                        title: { display: false }, // Already have H2
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: colors.tooltipBg,
                            titleColor: colors.tooltipText,
                            bodyColor: colors.tooltipText,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.x !== null) {
                                         // Add 'M' for millions
                                        label += '$' + context.parsed.x.toFixed(2) + 'M';
                                    }
                                    return label;
                                }
                            }
                        }
                     }
                 }
             });


            // --- Chart 3: Pie Chart (Losses by Initiative Focus) ---
            const focusLosses = allData.reduce((acc, item) => {
                if (item.estimatedLoss > 0) {
                    const focus = item.relatedInitiativeFocus || 'Unspecified';
                     // Optional: Normalize focus names (e.g., lowercase)
                    const normalizedFocus = focus.trim().toLowerCase();
                    acc[normalizedFocus] = (acc[normalizedFocus] || 0) + item.estimatedLoss;
                }
                return acc;
            }, {});

             // Capitalize first letter for display labels
             const capitalize = s => s.charAt(0).toUpperCase() + s.slice(1);
             const pieLabels = Object.keys(focusLosses).map(capitalize);
             const pieData = Object.values(focusLosses);

             const pieCtx = document.getElementById('pieChart').getContext('2d');
             pieChartInstance = new Chart(pieCtx, {
                 type: 'pie',
                 data: {
                     labels: pieLabels,
                     datasets: [{
                         label: 'Total Estimated Loss by Focus',
                         data: pieData,
                         backgroundColor: colors.pieColors, // Use the palette
                         borderColor: colors.pieColors.map(c => c.replace('0.8', '1')), // Make border opaque
                         borderWidth: 1
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         title: { display: false }, // Already have H2
                         legend: {
                             position: 'top', // Or 'bottom', 'left', 'right'
                             labels: { color: colors.labelColor }
                         },
                         tooltip: {
                            backgroundColor: colors.tooltipBg,
                            titleColor: colors.tooltipText,
                            bodyColor: colors.tooltipText,
                             callbacks: {
                                 label: function(context) {
                                     let label = context.label || '';
                                     if (label) { label += ': '; }
                                     if (context.parsed !== null) {
                                         // Add 'M' for millions and calculate percentage
                                         const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                         const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                         label += '$' + context.parsed.toFixed(2) + 'M (' + percentage + '%)';
                                     }
                                     return label;
                                 }
                             }
                         }
                     }
                 }
             });
        }

        // --- Dark Mode Logic ---
        function applyDarkMode(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                darkModeToggle.textContent = 'Light Mode';
            } else {
                document.body.classList.remove('dark-mode');
                darkModeToggle.textContent = 'Dark Mode';
            }
            // Re-render charts with updated colors
             createOrUpdateCharts();
        }

        darkModeToggle.addEventListener('click', () => {
            const isDarkModeEnabled = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDarkModeEnabled ? 'enabled' : 'disabled');
            applyDarkMode(isDarkModeEnabled); // Apply changes and re-render charts
        });

        // Check initial dark mode preference on load
         const savedMode = localStorage.getItem('darkMode');
         applyDarkMode(savedMode === 'enabled');


        // --- Initial Data Fetch ---
        async function fetchData() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const data = parseCSV(csvText);
                processAndDisplayData(data);
            } catch (error) {
                console.error('Error fetching or parsing data:', error);
                messageEl.innerHTML = `<p>Error loading data: ${error.message}. Please check the console or try again later.</p>`;
                 messageEl.style.color = 'red'; // Make error message prominent
                 // Optionally hide chart containers on error
                 document.querySelectorAll('.chart-container').forEach(c => c.style.display = 'none');
                 document.getElementById('dataTableContainer').style.display = 'none'; // Hide table too
                 document.querySelectorAll('h2').forEach(h => h.style.display = 'none'); // Hide chart titles
            }
        }

        // FORM SUBMISSION FUNCTIONS
        // --- Helper: Show Thank You Overlay ---
        function showConfirmation() {
            thankYouOverlay.classList.remove('hidden');
            // Hide after a short duration
            setTimeout(() => {
                thankYouOverlay.classList.add('hidden');
            }, 2500); // Show for 2.5 seconds
        }

        // --- Form Submission Logic ---
        async function handleFormSubmit(event) {
            event.preventDefault(); // Stop standard form submission

            if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL_GOES_HERE') {
                formMessage.textContent = 'Error: Apps Script URL not configured.';
                formMessage.className = 'error';
                return;
            }

            submitBtn.disabled = true;
            formMessage.textContent = 'Submitting...';
            formMessage.className = ''; // Clear previous status class

            // Construct data object from form
            const formData = new FormData(dataForm);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            // Basic cleanup for estimatedLoss before sending
            if (data.estimatedLoss) {
                data.estimatedLoss = String(data.estimatedLoss).replace(/[\$,M]/gi, '').trim();
            }


            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', // Required for cross-origin requests (even though it's Google)
                     // IMPORTANT: Apps Script doPost expects the payload differently depending on Content-Type
                     // Sending as plain text allows easier parsing in Apps Script via e.postData.contents
                    headers: {
                         'Content-Type': 'text/plain;charset=utf-8', // Send as plain text JSON string
                    },
                    body: JSON.stringify(data) // Send the data object as a JSON string
                });

                 // Check if response is OK (status 200-299)
                 if (!response.ok) {
                     // Try to parse error from Apps Script if available, otherwise use status text
                     let errorMsg = `HTTP error! Status: ${response.status} ${response.statusText}`;
                     try {
                         const errorJson = await response.json();
                         if (errorJson && errorJson.message) {
                           errorMsg = errorJson.message; // Use message from Apps Script response
                         }
                     } catch (e) { /* Ignore if response isn't JSON */ }
                     throw new Error(errorMsg);
                 }


                const result = await response.json(); // Parse the JSON response from Apps Script

                if (result.status === "success") {
                    formMessage.textContent = 'Success!';
                    formMessage.className = 'success';
                    dataForm.reset(); // Clear the form fields
                    showConfirmation(); // Show sparkles and Thank You

                    // Optional: Immediately refresh data (can be slow) or add row locally
                    // Option 1: Refetch all data (simplest for consistency)
                    console.log("Data added (ID:", result.addedId, "), refreshing data...");
                    fetchData(); // Re-run the initial data fetch and chart update

                    // Option 2: Add locally (faster but might mismatch if sheet edited elsewhere)
                    /*
                    const newEntry = { ...data, id: result.addedId };
                    // Ensure numeric types are correct if needed
                    newEntry.year = parseInt(newEntry.year, 10);
                    newEntry.estimatedLoss = parseFloat(newEntry.estimatedLoss);
                    allData.push(newEntry);
                    populateTable(allData); // Update table
                    createOrUpdateCharts(); // Update charts
                    */

                } else {
                    // Handle errors reported by the Apps Script logic
                    throw new Error(result.message || 'An unknown error occurred during submission.');
                }

            } catch (error) {
                console.error('Submission Error:', error);
                formMessage.textContent = `Error: ${error.message}`;
                formMessage.className = 'error';
            } finally {
                submitBtn.disabled = false; // Re-enable button
                 // Clear status message after a few seconds unless it was success
                 if (!formMessage.classList.contains('success')) {
                     setTimeout(() => { formMessage.textContent = ''; formMessage.className = ''; }, 5000);
                 }
            }
        }


        // --- Event Listeners ---
        // ... (Existing darkModeToggle listener) ...

        // Add listener for the new form
        if (dataForm) {
            dataForm.addEventListener('submit', handleFormSubmit);
        } else {
             console.error("Could not find data form element (#dataForm)");
        }
        
        // Fetch data when the page is loaded
        document.addEventListener('DOMContentLoaded', fetchData);
        // --- Initial Data Fetch ---
        // ... (Existing fetchData function and initial call) ...
        document.addEventListener('DOMContentLoaded', () => {
             fetchData();
             // Any other initialization
        });

    </script>
</body>
</html>
